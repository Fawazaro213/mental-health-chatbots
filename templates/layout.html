<!DOCTYPE html>
{% load static %}
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>{% block title %}MindCare{% endblock %}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Nunito+Sans:wght@400;600;700&family=Roboto:wght@400;500&display=swap" rel="stylesheet">
  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Font Awesome -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
  <!-- Custom CSS -->
  <link rel="stylesheet" href="{% static 'css/style.css' %}">
  <link rel="shortcut icon" href="{% static 'fav-mental.png' %}" type="image/x-icon">
  {% block extra_head %}{% endblock %}
  <style>
    /* Sidebar styles */
    .sidebar {
      width: 280px;
      background-color: var(--white-soft);
      box-shadow: 2px 0 10px rgba(0, 0, 0, 0.05);
      display: flex;
      flex-direction: column;
      transition: transform 0.3s ease;
      z-index: 1020;
    }

    @media (max-width: 991px) {
      .sidebar {
        position: fixed;
        top: 0;
        left: 0;
        height: 100vh;
        transform: translateX(-100%);
      }

      .sidebar.mobile-visible {
        transform: translateX(0);
      }

      .mobile-toggler {
        z-index: 1030;
      }

      .sidebar-close {
        display: block;
      }
    }

    @media (min-width: 992px) {
      .sidebar {
        position: relative;
        height: auto;
        transform: none !important;
      }

      .mobile-toggler,
      .sidebar-close {
        display: none;
      }
    }
  </style>
</head>

<body>

<!-- Mobile menu toggle button (icon-only) -->
<button class="mobile-toggler d-lg-none position-fixed top-0 start-0 m-3 z-1030 btn p-0 bg-transparent border-0" 
        id="mobileMenuToggler" aria-label="Open Sidebar">
  <i class="fas fa-bars fs-4 text-dark"></i>
</button>


<!-- Page Wrapper -->
<div class="wrapper d-flex">
  

{% with sidebar_mode|default:"default" as sidebar_mode %}
<aside class="sidebar" id="sidebar">
  <div class="sidebar-header p-3 d-flex align-items-center justify-content-between">
    <a href="{% url 'home' %}" class="d-flex align-items-center text-decoration-none">
      <img src="{% static 'images/hero-image.jpeg' %}" alt="MindCare" width="32" height="32">
      <span class="sidebar-brand ms-2" style="color: var(--teal-tranquil); font-weight: 700;">MindCare</span>
    </a>
    <button class="sidebar-close d-lg-none btn btn-sm text-muted" id="sidebarCloseBtn" aria-label="Close Sidebar">
      <i class="fas fa-times fs-5"></i>
    </button>
  </div>

  <!-- Sidebar Navigation -->
  <nav class="sidebar-nav d-flex flex-column h-100">
    <!-- Primary Navigation -->
<ul class="nav flex-column px-3 mb-2">
  <li class="nav-item">
    <a href="{% url 'dashboard' %}" class="nav-link d-flex align-items-center py-2 px-2 rounded">
      <i class="fas fa-home me-3" style="color: var(--pink-soft); width: 24px; text-align: center;"></i>
      <span class="nav-text">Dashboard</span>
    </a>
  </li>
  <li class="nav-item dropdown">
  <a class="nav-link dropdown-toggle d-flex align-items-center py-2 px-2 rounded" href="#" id="notifDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    <i class="fas fa-bell me-3" style="color: var(--lavender-light); width: 24px; text-align: center;"></i>
    <span class="nav-text">Notifications</span>
    {% if unread_notifications > 0 %}
      <span class="badge bg-danger ms-auto">{{ unread_notifications }}</span>
    {% endif %}
  </a>

  <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="notifDropdown" style="min-width: 300px;">
    {% for notif in recent_notifications %}
      <li>
        <a class="dropdown-item {% if not notif.is_read %}fw-bold{% endif %}" href="{{ notif.link|default:'#' }}">
          {{ notif.message }}
        </a>
      </li>
    {% empty %}
      <li><span class="dropdown-item text-muted">No notifications</span></li>
    {% endfor %}
    <li><hr class="dropdown-divider"></li>
    <li>
      <a class="dropdown-item text-center" href="{% url 'notification_list' %}">
        <i class="fas fa-eye me-2"></i> View All Notifications
      </a>
    </li>
  </ul>
</li>
</ul>

    {% if sidebar_mode == "chat" %}
    <!-- Chat Sessions Section -->
    <div class="px-3 py-3">
      <a href="{% url 'start_chat' %}" class="btn w-100 mb-3" style="background-color: var(--pink-soft);">
        <i class="fas fa-plus me-2"></i> New Chat
      </a>
      <h6 class="sidebar-section-title d-flex align-items-center">
        <i class="fas fa-history me-2" style="color: var(--teal-tranquil);"></i> Your Chats
      </h6>
      {% if grouped_sessions %}
        {% for label, sessions in grouped_sessions.items %}
          {% if sessions %}
            <div class="chat-group mb-2">
              <small class="text-uppercase text-muted d-block mb-1">{{ label }}</small>
              <div class="list-group list-group-flush">
                {% for session in sessions %}
                <div class="chat-session-item list-group-item px-2 py-2 border-0 d-flex flex-column{% if session.id|stringformat:"s" == current_session %} active{% endif %}" style="cursor: pointer;" data-chat-id="{{ session.id }}">
                  <div class="d-flex align-items-center">
                    <i class="fas fa-comment-dots me-2" style="color: var(--lavender-light);"></i>
                    <span class="chat-title flex-grow-1 text-truncate" data-session-id="{{ session.id }}" data-session-title="{{ session.title }}">
                      {{ session.title|default:"Untitled"|truncatechars:20 }}
                    </span>
                    <div class="dropdown chat-dropdown ms-2">
                      <button class="btn btn-sm text-muted dropdown-toggle" type="button" id="chatDropdown{{ session.id }}"
                        data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="fas fa-ellipsis-v"></i>
                      </button>
                      <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="chatDropdown{{ session.id }}">
                        <li><a class="dropdown-item rename-chat" href="#" data-id="{{ session.id }}">Rename</a></li>
                        <li><a class="dropdown-item delete-chat" href="#" data-id="{{ session.id }}">Delete</a></li>
                      </ul>
                    </div>
                  </div>
                  <small class="text-muted ms-4">{{ session.started_at|date:"M d, H:i" }}</small>
                </div>
                {% endfor %}
              </div>
            </div>
          {% endif %}
        {% endfor %}
      {% else %}
        <div class="text-center py-3">
          <i class="fas fa-comment-slash fa-2x mb-2" style="color: var(--gray-light);"></i>
          <p class="small text-muted">No chat sessions yet</p>
        </div>
      {% endif %}
    </div>
    {% else %}
    <!-- Default Sidebar Content -->
    <div class="px-3 py-3">
  <h6 class="sidebar-section-title">
    <i class="fas fa-link me-2" style="color: var(--teal-tranquil);"></i> Quick Links
  </h6>
  <ul class="nav flex-column">
    <li class="nav-item">
      <a href="{% url 'profile' %}" class="nav-link d-flex align-items-center py-2 px-2 rounded">
        <i class="fas fa-user-edit me-3" style="color: var(--pink-soft); width: 24px; text-align: center;"></i>
        <span class="nav-text">Edit Profile</span>
      </a>
    </li>
    <li class="nav-item">
      <a href="{% url 'start_chat' %}" class="nav-link d-flex align-items-center py-2 px-2 rounded">
        <i class="fas fa-robot me-3" style="color: var(--lavender-light); width: 24px; text-align: center;"></i>
        <span class="nav-text">Chatbot</span>
      </a>
    </li>
    <li class="nav-item">
      <a href="{% url 'chat_history' %}" class="nav-link d-flex align-items-center py-2 px-2 rounded">
        <i class="fas fa-clock me-3" style="color: var(--teal-tranquil); width: 24px; text-align: center;"></i>
        <span class="nav-text">View Chat History</span>
      </a>
    </li>
    <li class="nav-item">
      <a href="{% url 'emergency_contacts' %}" class="nav-link d-flex align-items-center py-2 px-2 rounded">
        <i class="fas fa-phone-alt me-3" style="color: var(--coral-gentle); width: 24px; text-align: center;"></i>
        <span class="nav-text">Emergency Contacts</span>
      </a>
    </li>
  </ul>
</div>
    {% endif %}

    <!-- Footer Navigation -->
    <div class="mt-auto px-3 py-3 border-top">
      <ul class="nav flex-column">
        <li class="nav-item">
          <a href="{% url 'logout' %}" class="nav-link d-flex align-items-center py-2 px-2 rounded">
            <i class="fas fa-sign-out-alt me-3" style="color: var(--coral-gentle); width: 24px; text-align: center;"></i>
            <span class="nav-text">Logout</span>
          </a>
        </li>
      </ul>
    </div>
  </nav>
</aside>
{% endwith %}


  <!-- Main Content -->
  <div class="main-content flex-grow-1 p-4" id="mainContent">
    {% if messages %}
      <div class="position-fixed top-0 start-50 translate-middle-x mt-3" style="z-index: 1055; width: auto; max-width: 90%;">
        {% for message in messages %}
          <div class="alert alert-{{ message.tags }} alert-dismissible fade show shadow" role="alert" style="min-width: 300px;">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
        {% endfor %}
      </div>
    {% endif %}
    {% block content %}{% endblock %}
  </div>
</div>


<!-- Rename Chat Modal -->
<div class="modal fade" id="renameChatModal" tabindex="-1" aria-labelledby="renameChatModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content" style="background-color: var(--white-soft); border-radius: 12px;">
      <form id="renameChatForm">
        <div class="modal-header" style="background-color: var(--teal-tranquil); color: white; border-top-left-radius: 12px; border-top-right-radius: 12px;">
          <h5 class="modal-title" id="renameChatModalLabel">
            <i class="fas fa-edit me-2"></i> Rename Chat
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="renameChatId">
          <div class="mb-3">
            <label for="newChatTitle" class="form-label text-muted">New Title</label>
            <input type="text" class="form-control" id="newChatTitle" required style="border-radius: 8px;">
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn" style="background-color: var(--pink-soft); color: white;">
            <i class="fas fa-check me-1"></i> Rename
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteChatModal" tabindex="-1" aria-labelledby="deleteChatModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="deleteChatForm">
        <div class="modal-header bg-danger text-white">
          <h5 class="modal-title" id="deleteChatModalLabel"><i class="fas fa-exclamation-triangle me-2"></i>Confirm Delete</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="deleteChatId">
          <p>Are you sure you want to delete this chat?</p>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-danger">Yes, Delete</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Footer -->
<footer class="py-3 mt-auto" style="background-color: var(--gray-dark); color: var(--white-soft);">
  <div class="container text-center">
    <p class="mb-0">&copy; {{ year|default:2025 }} MindCare. All rights reserved.</p>
  </div>
</footer>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const sidebar = document.getElementById('sidebar');
    const openBtn = document.getElementById('mobileMenuToggler');
    const closeBtn = document.getElementById('sidebarCloseBtn');

    if (openBtn && sidebar) {
      openBtn.addEventListener('click', () => {
        sidebar.classList.add('mobile-visible');
      });
    }

    if (closeBtn && sidebar) {
      closeBtn.addEventListener('click', () => {
        sidebar.classList.remove('mobile-visible');
      });
    }

    document.addEventListener('click', function (e) {
      if (window.innerWidth < 992 && sidebar.classList.contains('mobile-visible')) {
        if (!sidebar.contains(e.target) && !openBtn.contains(e.target)) {
          sidebar.classList.remove('mobile-visible');
        }
      }
    });
  });





  document.addEventListener('DOMContentLoaded', function () {
  const sidebar = document.getElementById('sidebar');
  const openBtn = document.getElementById('mobileMenuToggler');
  const closeBtn = document.getElementById('sidebarCloseBtn');

  const hideMenuBtn = () => openBtn.style.display = 'none';
  const showMenuBtn = () => openBtn.style.display = 'block';

  if (openBtn && sidebar) {
    openBtn.addEventListener('click', () => {
      sidebar.classList.add('mobile-visible');
      hideMenuBtn();
    });
  }

  if (closeBtn && sidebar) {
    closeBtn.addEventListener('click', () => {
      sidebar.classList.remove('mobile-visible');
      showMenuBtn();
    });
  }

  document.addEventListener('click', function (e) {
    if (window.innerWidth < 992 && sidebar.classList.contains('mobile-visible')) {
      if (!sidebar.contains(e.target) && !openBtn.contains(e.target)) {
        sidebar.classList.remove('mobile-visible');
        showMenuBtn();
      }
    }
  });
});

</script>
<script>
  setTimeout(function () {
    document.querySelectorAll('.alert').forEach(function (alert) {
      bootstrap.Alert.getOrCreateInstance(alert).close();
    });
  }, 7000);
</script>

<script>
document.addEventListener('DOMContentLoaded', function () {
  let renameModal = new bootstrap.Modal(document.getElementById('renameChatModal'));
  let deleteModal = new bootstrap.Modal(document.getElementById('deleteChatModal'));

  // Trigger Rename Modal
  document.querySelectorAll('.rename-chat').forEach(button => {
    button.addEventListener('click', function (e) {
      e.preventDefault();
      const chatId = this.dataset.id;
      const chatTitleSpan = document.querySelector(`.chat-title[data-session-id="${chatId}"]`);
      document.getElementById('renameChatId').value = chatId;
      document.getElementById('newChatTitle').value = chatTitleSpan.textContent.trim();
      renameModal.show();
    });
  });

  // Submit Rename Form
  document.getElementById('renameChatForm').addEventListener('submit', function (e) {
    e.preventDefault();
    const chatId = document.getElementById('renameChatId').value;
    const newTitle = document.getElementById('newChatTitle').value;

    fetch("{% url 'rename_chat' %}", {
      method: "POST",
      headers: {
        "X-CSRFToken": "{{ csrf_token }}",
        "Content-Type": "application/x-www-form-urlencoded",
        "X-Requested-With": "XMLHttpRequest",
      },
      body: new URLSearchParams({ session_id: chatId, title: newTitle })
    })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        const chatTitleSpan = document.querySelector(`.chat-title[data-session-id="${chatId}"]`);
        chatTitleSpan.textContent = data.new_title;
        renameModal.hide();
      } else {
        alert("Could not rename chat.");
      }
    });
  });

  // Trigger Delete Modal
  document.querySelectorAll('.delete-chat').forEach(button => {
    button.addEventListener('click', function (e) {
      e.preventDefault();
      const chatId = this.dataset.id;
      document.getElementById('deleteChatId').value = chatId;
      deleteModal.show();
    });
  });

  // Submit Delete Form
  document.getElementById('deleteChatForm').addEventListener('submit', function (e) {
    e.preventDefault();
    const chatId = document.getElementById('deleteChatId').value;

    fetch("{% url 'delete_chat' %}", {
      method: "POST",
      headers: {
        "X-CSRFToken": "{{ csrf_token }}",
        "Content-Type": "application/x-www-form-urlencoded",
        "X-Requested-With": "XMLHttpRequest",
      },
      body: new URLSearchParams({ session_id: chatId })
    })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        const chatItem = document.querySelector(`.chat-title[data-session-id="${chatId}"]`).closest('.chat-session-item');
        chatItem.remove();
        deleteModal.hide();
      } else {
        alert("Could not delete chat.");
      }
    });
  });

  // Handle chat session clicks for navigation
  document.querySelectorAll('.chat-session-item').forEach(item => {
    item.addEventListener('click', function(e) {
      // Don't navigate if clicking on dropdown or its children
      if (e.target.closest('.dropdown') || e.target.closest('.chat-dropdown')) {
        return;
      }
      
      const chatId = this.getAttribute('data-chat-id');
      if (chatId) {
        window.location.href = `/c/chat/${chatId}/`;
      }
    });
  });
});
</script>


{% block extra_js %}{% endblock %}
</body>
</html>
