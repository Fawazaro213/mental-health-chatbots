{% extends "layout.html" %}
{% block title %}Mood History{% endblock %}

{% block content %}
<div class="mood-history-container py-4" style="background-color: var(--gray-light); min-height: 80vh;">
  <div class="container">
    <!-- Header -->
    <div class="text-center mb-4">
      <h2 class="mood-history-title">
        <i class="fas fa-chart-line me-2" style="color: var(--pink-soft);"></i>
        Your Mood History
      </h2>
      <p class="text-muted">Track your emotional journey over time</p>
    </div>

    <!-- Time Period Filter -->
    <div class="text-center mb-4">
      <div class="btn-group" role="group" aria-label="Time Period Selector">
        <button type="button" class="btn btn-period active" data-period="7">Last 7 Days</button>
        <button type="button" class="btn btn-period" data-period="30">Last 30 Days</button>
        <button type="button" class="btn btn-period" data-period="90">Last 90 Days</button>
        <button type="button" class="btn btn-period" data-period="0">All Time</button>
      </div>
    </div>

    <!-- Mood Chart -->
    <div class="mood-chart-container mb-4 p-4 rounded" style="background-color: var(--white-soft); height: 350px;">
      <canvas id="moodChart"></canvas>
    </div>

    <!-- Mood Statistics -->
    <div class="row mood-stats mb-4">
      <div class="col-md-4 mb-3">
        <div class="stat-card text-center p-3 rounded">
          <div class="stat-value" style="color: var(--teal-tranquil);">
            {{ average_mood|floatformat:1 }}
          </div>
          <div class="stat-label">Average Mood</div>
        </div>
      </div>
      <div class="col-md-4 mb-3">
        <div class="stat-card text-center p-3 rounded">
          <div class="stat-value" style="color: var(--lavender-light);">
            {{ highest_mood.score }}
          </div>
          <div class="stat-label">Highest Mood ({{ highest_mood.timestamp|date:"M d" }})</div>
        </div>
      </div>
      <div class="col-md-4 mb-3">
        <div class="stat-card text-center p-3 rounded">
          <div class="stat-value" style="color: var(--coral-gentle);">
            {{ lowest_mood.score }}
          </div>
          <div class="stat-label">Lowest Mood ({{ lowest_mood.timestamp|date:"M d" }})</div>
        </div>
      </div>
    </div>

    <!-- Recent Mood Entries -->
    <div class="mood-entries-container p-4 rounded" style="background-color: var(--white-soft);">
      <h5 class="mb-3">
        <i class="fas fa-list-ul me-2" style="color: var(--teal-tranquil);"></i>
        Recent Mood Entries
      </h5>
      <div class="list-group">
        {% for mood in recent_moods %}
        <div class="mood-entry list-group-item border-0 py-3">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <span class="mood-entry-score" style="color: var(--pink-soft);">
                {{ mood.score }}/10
              </span>
              <span class="emoji ms-2">
                {% if mood.score >= 8 %} üòÑ
                {% elif mood.score >= 5 %} üòê
                {% else %} üòû
                {% endif %}
              </span>
              <span class="mood-entry-date text-muted ms-2">
                {{ mood.timestamp|date:"M d, Y H:i" }}
              </span>
            </div>
            {% if mood.note %}
            <button class="btn btn-sm mood-note-toggle" data-bs-toggle="collapse" data-bs-target="#note-{{ mood.id }}">
              <i class="fas fa-comment-dots"></i>
            </button>
            {% endif %}
          </div>
          {% if mood.note %}
          <div class="collapse" id="note-{{ mood.id }}">
            <div class="mood-entry-note mt-2 p-2 rounded" style="background-color: rgba(245, 195, 191, 0.1);">
              <i class="fas fa-quote-left me-2" style="color: var(--lavender-light);"></i>
              {{ mood.note }}
            </div>
          </div>
          {% endif %}
        </div>
        {% empty %}
        <div class="text-center py-4">
          <i class="far fa-chart-bar fa-2x mb-3" style="color: var(--gray-light);"></i>
          <p>No mood entries yet</p>
          <a href="{% url 'mood_check' %}" class="btn btn-sm" style="background-color: var(--pink-soft);">
            <i class="fas fa-plus-circle me-2"></i>Add Mood Check
          </a>
        </div>
        {% endfor %}
      </div>
    </div>
  </div>
</div>

<!-- Chart.js + Date Adapter -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function () {
  const ctx = document.getElementById('moodChart').getContext('2d');

  const allDataPoints = [
    {% for mood in all_moods %}
    {
      x: "{{ mood.timestamp|date:'Y-m-d H:i' }}",
      y: {{ mood.score }},
      note: "{{ mood.note|escapejs }}"
    },
    {% endfor %}
  ];

  const gradient = ctx.createLinearGradient(0, 0, 0, 400);
  gradient.addColorStop(0, 'rgba(94, 200, 200, 0.8)');
  gradient.addColorStop(1, 'rgba(245, 195, 191, 0.2)');

  const moodChart = new Chart(ctx, {
    type: 'line',
    data: {
      datasets: [{
        label: 'Mood Score',
        data: allDataPoints,
        parsing: {
          xAxisKey: 'x',
          yAxisKey: 'y'
        },
        fill: true,
        backgroundColor: gradient,
        borderColor: 'var(--teal-tranquil)',
        borderWidth: 3,
        pointBackgroundColor: 'var(--pink-soft)',
        pointRadius: 5,
        pointHoverRadius: 7,
        tension: 0.3
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        y: {
          min: 0,
          max: 10,
          title: {
            display: true,
            text: 'Mood (1‚Äì10)'
          },
          grid: {
            color: 'rgba(0,0,0,0.05)'
          }
        },
        x: {
          type: 'time',
          time: {
            unit: 'day',
            tooltipFormat: 'PPpp'
          },
          title: {
            display: true,
            text: 'Date'
          },
          grid: {
            display: false
          }
        }
      },
      plugins: {
        tooltip: {
          backgroundColor: 'var(--gray-dark)',
          callbacks: {
            label: function (context) {
              const score = context.parsed.y;
              const note = context.raw.note;
              return note ? `Score: ${score} | Note: ${note}` : `Score: ${score}`;
            }
          }
        },
        legend: {
          display: false
        }
      }
    }
  });

  // Period filter
  const buttons = document.querySelectorAll('.btn-period');
  buttons.forEach(btn => {
    btn.addEventListener('click', function () {
      buttons.forEach(b => b.classList.remove('active'));
      this.classList.add('active');

      const days = parseInt(this.dataset.period);
      let filtered = allDataPoints;

      if (days > 0) {
        const now = new Date();
        const cutoff = new Date(now.getTime() - days * 24 * 60 * 60 * 1000);
        filtered = allDataPoints.filter(entry => new Date(entry.x) >= cutoff);
      }

      moodChart.data.datasets[0].data = filtered;
      moodChart.update();
    });
  });

  // Toggle mood note icons
  document.querySelectorAll('.mood-note-toggle').forEach(toggle => {
    toggle.addEventListener('click', function () {
      const icon = this.querySelector('i');
      icon.classList.toggle('fa-comment-dots');
      icon.classList.toggle('fa-comment-slash');
    });
  });
});
</script>

<style>
.mood-history-title {
  color: var(--gray-dark);
  font-weight: 700;
}
.btn-period {
  background-color: var(--white-soft);
  color: var(--gray-dark);
  border: 1px solid #dee2e6;
  padding: 0.5rem 1rem;
  font-size: 0.9rem;
}
.btn-period.active {
  background-color: var(--teal-tranquil);
  color: white;
}
.stat-card {
  background-color: var(--white-soft);
  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
  border-left: 5px solid var(--teal-tranquil);
  transition: all 0.3s ease;
}
.stat-card:hover {
  transform: translateY(-5px);
}
.stat-value {
  font-size: 2.5rem;
  font-weight: 700;
}
.stat-label {
  color: var(--gray-dark);
  font-size: 0.9rem;
  opacity: 0.8;
}
.mood-entry {
  border-bottom: 1px solid rgba(0, 0, 0, 0.05);
}
.mood-entry:last-child {
  border-bottom: none;
}
.mood-entry-score {
  font-weight: 600;
}
.mood-note-toggle {
  color: var(--lavender-light);
  background: none;
  border: none;
}
.mood-note-toggle:hover {
  color: var(--teal-tranquil);
}
.mood-entry-note {
  font-size: 0.9rem;
  line-height: 1.5;
}
</style>
{% endblock %}
